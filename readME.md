This commit is not perfect yet, the code is still too messy